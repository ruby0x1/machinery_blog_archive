











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="How we implemented the save game system for The Machinery."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/sgs__prototype.png"/>
  
  <meta name="twitter:title" content="One-Click Save Game System -- Part 1">
  <meta name="twitter:description" content="How we implemented the save game system for The Machinery."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="One-Click Save Game System -- Part 1 · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/save-game-system-part-1/"/>
  
  <meta property="og:image" content="../../images/sgs__prototype.png"/>
  
  
  <meta property="og:description" content="How we implemented the save game system for The Machinery."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2021-06-21T00:00:00Z"/>
  

  <title>One-Click Save Game System -- Part 1 &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" integrity="" print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" integrity="" print"/>
  

  
  
  <link href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    

  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js" integrity=""></script>
  <script type="text/javascript" src="../../js/page.min.js" integrity=""></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20210804185421/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20210804185421\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Leonardo Lucania",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20210804185421\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "One-Click Save Game System -- Part 1",
    "name": "One-Click Save Game System -- Part 1",
    "wordCount":  1392 ,
    "timeRequired": "PT7M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/save-game-system-part-1/",
    "datePublished": "2021-06-21T00:00Z",
    "dateModified": "2021-06-21T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://web.archive.org/web/20210804185421/https://ourmachinery.com/sgs__prototype.png"
    },
    
    
    "description": "How we implemented the save game system for The Machinery."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                About
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/product.html" aria-label="Link The Machinery">The Machinery</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/about.html" aria-label="Link About Us">About Us</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/press.html" aria-label="Link Press Kit">Press Kit</a>
                </li>
                
              </ul>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Learning &amp; Support
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Link API Documentation" target="_blank">API Documentation</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/tutorials/" aria-label="Link Tutorials">Tutorials</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/videos.html" aria-label="Link Videos">Videos</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/samples.html" aria-label="Link Sample Projects">Sample Projects</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804185421/https://github.com/OurMachinery/themachinery-public/issues" aria-label="Link Issue Tracker" target="_blank">Issue Tracker</a>
                </li>
                
              </ul>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/tutorials/">Tutorials</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804185421/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/tutorials/" aria-label="Opens Tutorial" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Tutorials</span></a>
        <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>One-Click Save Game System -- Part 1</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2021-06-21T00:00:00Z">
          Jun 21, 2021
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>Hello fellow developers! It&rsquo;s Leo here.</p>
<p>I&rsquo;ve been working on a Save Game system for The Machinery for quite a while now. A first version of
the system, which we call the “Gamestate”, will be available for you to play around with in 2021.6.
Considering how interesting and challenging the experience was for me, I thought it would be nice to
share what went wrong, what went right, but most importantly how the design process went from
&ldquo;paper&rdquo; to a first working prototype to the final system implementation and integration.</p>
<p>Note: I’ll be referring to “The user” quite a lot in this post. What I mean is not the end-user of
the game engine, but rather the “user” of the Gamestate API, which will be the game code in most
cases.</p>
<h2 id="requirements-part-1">Requirements, part 1</h2>
<p>A <em>Save Game System</em> is a pretty generic term. So the first thing we did was to clarify what the
system needed to do. The most important functionalities we identified were:</p>
<ol>
<li>
<p>Telling the system what the <em>State</em> of the application looks like (what kind of objects exist,
what members/fields they have, etc). We want to be flexible here, and not assume any particular
layout of the <em>State,</em> since it can vary a lot from game to game.</p>
</li>
<li>
<p>Notifying the <em>Gamestate</em> about changes to the application’s state. For example, when an <em>Entity</em>
moves, the game will notify the <em>Gamestate</em> of its new position. You can think of this as
mirroring the actual state of the application (position of an entity) into the more abstract
<em>Gamestate</em>. (But it does not necessarily have to be a mirror operation, some games may choose to
keep all their state data in the <em>Gamestate.)</em></p>
</li>
<li>
<p>Being able to <em>Save</em> and later <em>Load</em> the state. This involves serializing the <em>Gamestate</em> to a
binary representation and later recreating first the <em>Gamestate</em> from the serialized file and
then the application’s concrete state from the abstract <em>Gamestate.</em></p>
</li>
<li>
<p>The system will eventually play a crucial role in supporting multiplayer games, so we want to
always keep that in the back of our heads. (At the end of the day, you can see sending data to
another machine as dumping data to a file and sending that file to the other machine, the other
machine will just read back that file and apply those changes to its own state.)</p>
</li>
</ol>
<p>We noticed that the first three requirements (let’s consider the fourth one a <em>bonus</em> requirement)
map very well to three distinct &ldquo;phases&rdquo; in the lifecycle of the <em>Gamestate</em>*,* so we tried to
design our API around that:</p>
<ol>
<li>
<p>Configuration. (Things that will only happen at the startup of the application)</p>
</li>
<li>
<p>Runtime. (Things that potentially happen many times per frame, as the simulation is run)</p>
</li>
<li>
<p>One-time actions. (“Special” things that will only happen from time to time under specific
circumstances)</p>
</li>
</ol>
<p>Based on this, we sketched out a basic pseudo-code API:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Configuration
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_object_type</span>(game_state<span style="color:#f92672">*</span> gs, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_struct_type</span>(game_state<span style="color:#f92672">*</span> gs, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name, member<span style="color:#f92672">*</span> members, uint32_t n_members);

<span style="color:#75715e">// Runtime
</span><span style="color:#75715e"></span>object_id <span style="color:#a6e22e">create_object</span>(game_state<span style="color:#f92672">*</span> gs, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> type_name);
struct_id <span style="color:#a6e22e">create_struct</span>(game_state<span style="color:#f92672">*</span> gs, object_id, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> struct_name);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change_member</span>(game_state<span style="color:#f92672">*</span> gs, object_id o, struct_id s, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> member_name, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value);

<span style="color:#66d9ef">struct</span> buffer
{
  uint8_t<span style="color:#f92672">*</span> data;
  uint32_t size;
};

<span style="color:#75715e">// One-time actions
</span><span style="color:#75715e"></span>buffer <span style="color:#a6e22e">dump_to_buffer</span>(game_state<span style="color:#f92672">*</span> gs);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load_from_buffer</span>(game_state<span style="color:#f92672">*</span> gs, buffer b);
</code></pre></div><h2 id="basic-prototype">Basic prototype</h2>
<p>an exploratory proof-of-concept if you will.
Once we were satisfied with this rough on-paper design, I proceeded to implement a basic prototype,</p>
<p>I decided to create a special purpose tab in The Machinery with a simple mini-game inside it. This
&ldquo;game&rdquo; consisted of a couple of buttons and some shapes changing color and moving around on the
screen:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Yeah, I know… it almost won the GOTY award." src="../../images/sgs__prototype.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Yeah, I know… it almost won the GOTY award.</h4>
    </figcaption>
  </figure>
<p>Once I’d implemented this and was able to store and restore the state of this minigame, I took
another look at the original requirements with much clearer ideas in my head. Back at the
whiteboard, I knew that there were other things that needed to happen for the system to serve all of
the use cases. I was also able to make the previous requirements much less vague:</p>
<ol>
<li>There’s an explicit <em>Configuration</em> phase of the system where the user defines what the
<em>Persistent State</em> looks like. (This is still quite generic, but we&rsquo;ll come back to that later.)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Sample pseudocode:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> tm_object_type;
<span style="color:#66d9ef">struct</span> tm_struct_type;
<span style="color:#66d9ef">struct</span> tm_member_id;
<span style="color:#66d9ef">struct</span> square;
<span style="color:#66d9ef">struct</span> circle;

<span style="color:#66d9ef">struct</span> application_state
{
  tm_object_type square;
  tm_object_type circle;

  tm_struct_type position;
  tm_struct_type color;
  tm_struct_type parent;
  tm_struct_type dimension;

  uint32_t square_count;
  square<span style="color:#f92672">*</span> squares;

  uint32_t circle_count;
  circle<span style="color:#f92672">*</span> circles;

  tm_gamestate<span style="color:#f92672">*</span> persistent_state;
};

<span style="color:#66d9ef">static</span> global_application_state global;

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure_saved_game</span>()
{
  tm_gamestate<span style="color:#f92672">*</span> gamestate <span style="color:#f92672">=</span> global.persistent_state;
  global.square <span style="color:#f92672">=</span> tm_gamestate_api<span style="color:#f92672">-&gt;</span>configure_object_type(gamestate, <span style="color:#e6db74">&#34;square&#34;</span>, square_restored_from_saved_game_callback);
  global.circle <span style="color:#f92672">=</span> tm_gamestate_api<span style="color:#f92672">-&gt;</span>configure_object_type(gamestate, <span style="color:#e6db74">&#34;circle&#34;</span>, circle_restored_from_saved_game_callback);

  global.position <span style="color:#f92672">=</span> tm_gamestate_api<span style="color:#f92672">-&gt;</span>configure_struct_type(gamestate, <span style="color:#e6db74">&#34;position&#34;</span>);
  tm_gamestate_api<span style="color:#f92672">-&gt;</span>add_vec3_member(gamestate, global.position, <span style="color:#e6db74">&#34;position_member&#34;</span>);

  global.color <span style="color:#f92672">=</span> tm_gamestate_api<span style="color:#f92672">-&gt;</span>configure_struct_type(gamestate, <span style="color:#e6db74">&#34;color&#34;</span>);
  tm_gamestate_api<span style="color:#f92672">-&gt;</span>add_vec4_member(gamestate, global.color, <span style="color:#e6db74">&#34;color_member&#34;</span>);
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>}
</code></pre></div><ol start="2">
<li>As the application runs, the <em>State</em> changes. We push those changes to the <em>Gamestate</em> so it can
keep track of them. Note that we don’t necessarily need to push the state changes every frame… it
is sufficient if we make sure that all changes have been pushed when the <em>Save</em> happens. We leave
it up to the user to decide how often (or not) they want to push changes.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> square
{
  tm_vec3_t P;
  tm_vec4_t color;
  tm_vec2_t dim;
  uint32_t parent_index;
};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update_square_position</span>(uint32_t square_index, tm_vec3_t P)
{
  square<span style="color:#f92672">*</span> square <span style="color:#f92672">=</span> global.squares <span style="color:#f92672">+</span> square_index;
  square<span style="color:#f92672">-&gt;</span>P <span style="color:#f92672">=</span> P;

  <span style="color:#75715e">// This will much probably be a lookup in a hash table (it will be filled when
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// objects are first created).
</span><span style="color:#75715e"></span>  object_id persistent_id <span style="color:#f92672">=</span> get_persistent_id_for(square_index);
  tm_gamestate_api<span style="color:#f92672">-&gt;</span>member_changed(global.gamestate, persistent_id, global.position, <span style="color:#e6db74">&#34;position_member&#34;</span>, <span style="color:#f92672">&amp;</span>P);
}
</code></pre></div><ol start="3">
<li>Saving the State of the simulation means serializing data to a buffer while Restoring it will
involve deserializing data from a buffer and into the actual game structures.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Very high level pseudocode.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> buffer <span style="color:#a6e22e">serialize_to_disk</span>(tm_gamestate<span style="color:#f92672">*</span> gamestate)
{
  buffer result <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  <span style="color:#66d9ef">for</span>(uint32_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> gamestate<span style="color:#f92672">-&gt;</span>change_count; <span style="color:#f92672">++</span>i)
  {
    change<span style="color:#f92672">*</span> change <span style="color:#f92672">=</span> gamestate<span style="color:#f92672">-&gt;</span>changes <span style="color:#f92672">+</span> i;
    serialize_to_buffer(change, buffer);
  }

  <span style="color:#66d9ef">return</span> result;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deserialze_to_disk</span>(tm_gamestate<span style="color:#f92672">*</span> gamestate, buffer b)
{
  <span style="color:#66d9ef">while</span>(b.size)
  {
    change c;
    deserialize_from_buffer(<span style="color:#f92672">&amp;</span>c, <span style="color:#f92672">&amp;</span>buffer);
    <span style="color:#75715e">// This will callback into the gamecode so that it can do the proper thing.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// (Create object, change data, etc)
</span><span style="color:#75715e"></span>    apply_change_to_application_state(gamestate, <span style="color:#f92672">&amp;</span>c);
  }
}
</code></pre></div><ol start="4">
<li>Every persistent object needs a unique identifier. So It’s either the <em>gamestate</em> that
automatically assigns an <em>object_id</em> to each persistent object or it’s the user’s responsibility
to generate unique <em>object_id</em>s and pass them to the API.</li>
</ol>
<p>At this point of the design process, we didn’t know what solution could work best in the end, so
we decided to go with the one that seemed more flexible at the time: the user is responsible for
generating unique IDs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> object_id
{
  uint64_t u64;
};

<span style="color:#75715e">// You can generate persistent id&#39;s however you want, the important thing is that
</span><span style="color:#75715e">// each object has a unique persistent_id.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> object_id <span style="color:#a6e22e">generate_persistent_id</span>()
{
  object_id result <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  result.u64 <span style="color:#f92672">=</span> (uint64_t) random_ensure_unique();
  <span style="color:#66d9ef">return</span> result;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">create_persistent_square</span>()
{
  object_id id <span style="color:#f92672">=</span> generate_persistent_id();
  tm_gamestate_api<span style="color:#f92672">-&gt;</span>create_object(gamestate, application_state<span style="color:#f92672">-&gt;</span>square, id);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">create_persistent_circle</span>()
{
  object_id id <span style="color:#f92672">=</span> generate_cpersistent_id();
  tm_gamestate_api<span style="color:#f92672">-&gt;</span>create_object(gamestate, application_state<span style="color:#f92672">-&gt;</span>circle, id);
}

<span style="color:#75715e">// This is the callback that the Saved Game will call when an object needs to be
</span><span style="color:#75715e">// created.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">square_restored_from_saved_game_callback</span>(object_id to_create)
{
  create_square();
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">circle_restored_from_saved_game_callback</span>(object_id to_create)
{
  create_circle();
}
</code></pre></div><ol start="5">
<li>
<p>The Gamestate should be able to work at a <em>Member</em> granularity. I.e., the user should be able to
push a change to a single <em>Member</em> of a <em>Struct</em> in an <em>Object</em>. This will help us immensely with
multiplayer: only the actual member that changed will be sent across the network (instead of the
full struct), and in addition to this users will have the possibility to encode/decode the
members however they want.</p>
</li>
<li>
<p>We want to support references. The state of an application might involve objects referencing
other objects, so the <em>Gamestate</em> needs to support it.</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> circle
{
  tm_vec3_t P;
  tm_vec4_t color;
  <span style="color:#66d9ef">float</span> r;
  uint32_t parent_index;
};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update_circle_parent</span>(uint32_t circle_index, uint32_t parent_index)
{
  circle<span style="color:#f92672">*</span> circle <span style="color:#f92672">=</span> global.circles <span style="color:#f92672">+</span> circle_index;
  square<span style="color:#f92672">-&gt;</span>parent_index <span style="color:#f92672">=</span> parent_index;

  <span style="color:#75715e">// Note that we have to &#34;query&#34; for both the object itself and the object we want to
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// reference.
</span><span style="color:#75715e"></span>  object_id persistent_id <span style="color:#f92672">=</span> get_persistent_id_for(circle_index);
  object_id reference_persistent_id <span style="color:#f92672">=</span> get_persistent_id_for(parent_index);
  tm_gamestate_api<span style="color:#f92672">-&gt;</span>member_changed(global.gamestate, persistent_id, global.parent, <span style="color:#e6db74">&#34;parent_member&#34;</span>, reference_persistent_id);
}
</code></pre></div><p>And this Concludes the first big “iteration” that was done on the system: the one that dealt mostly
with the initial on-paper requirements and prototype.</p>
<p>Next time around we’ll take a look at how we approached the problem of integrating the system with
our Entity-Component System.</p>
<p>Take care,
Leonardo</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/authors/leo" class="text-decoration-none">Leonardo Lucania</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804185421/https://twitter.com/share?text=One-Click%20Save%20Game%20System%20--%20Part%201 - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fsave-game-system-part-1%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804185421/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fsave-game-system-part-1%2f&amp;description=One-Click%20Save%20Game%20System%20--%20Part%201" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/beta-2021-5/" class="text-decoration-none"><img src="../../images/beta_21_5__fabrik.png" class="card-img-top" alt="The Machinery Beta — May 2021 (version 2021.5)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta-2021-5/">The Machinery Beta — May 2021 (version 2021.5)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2021-05-27T00:00:00Z">
                      27 May 2021
                    </time>
                  </h6>
                  <p class="card-text"><p>Here at Our Machinery, we’re pretty excited about the flexibility of The Machinery. It offers
options in customizing …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta-2021-5/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">7 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/a-debugging-story/" class="text-decoration-none"><img src="../../images/a-debugging-story.png" class="card-img-top" alt="A Debugging Story"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/a-debugging-story/">A Debugging Story</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2021-05-03T00:00:00Z">
                      3 May 2021
                    </time>
                  </h6>
                  <p class="card-text"><p>I&rsquo;ve been wanting for some time to write something about debugging. I think it&rsquo;s a really important
topic …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/a-debugging-story/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">1 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/beta-2021-4/" class="text-decoration-none"><img src="../../images/beta_21_4__triggers.png" class="card-img-top" alt="The Machinery Beta — April 2021 (version 2021.4)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta-2021-4/">The Machinery Beta — April 2021 (version 2021.4)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2021-04-29T00:00:00Z">
                      29 Apr 2021
                    </time>
                  </h6>
                  <p class="card-text">It’s that time again! A new month and a new The Machinery release. Hope you are enjoying the longer, sunnier days, as …</p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta-2021-4/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">7 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/save-game-system-part-1/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20210804185421/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804185421/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/cdn-cgi/l/email-protection#16667f7871567963647b77757e7f7873646f3875797b" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
        <p>&copy; Our Machinery 2021 <a style="text-decoration:none; margin-left:1em;" href="http://web.archive.org/web/20210804185421/https://ourmachinery.com/privacy.html">Privacy Policy</a></p>
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 18:54:21 Aug 04, 2021 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:51:44 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 89.895
  exclusion.robots: 0.101
  exclusion.robots.policy: 0.092
  cdx.remote: 0.074
  esindex: 0.011
  LoadShardBlock: 41.436 (3)
  PetaboxLoader3.datanode: 78.53 (4)
  CDXLines.iter: 20.845 (3)
  load_resource: 402.06
  PetaboxLoader3.resolve: 336.054
-->