











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content=""/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/machinery-logo.png"/>
  
  <meta name="twitter:title" content="One Draw Call UI">
  <meta name="twitter:description" content=""/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="One Draw Call UI · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/one-draw-call-ui/"/>
  
  <meta property="og:image" content="../../images/machinery-logo.png"/>
  
  
  <meta property="og:description" content=""/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2017-07-17T00:00:00Z"/>
  

  <title>One Draw Call UI &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" media="screen, print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" media="screen, print"/>
  

  
  
  <link href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    ga('set', 'anonymizeIp', true);
    
  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="../../js/page.min.js?v=1.16"></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20220702205403/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20220702205403\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Niklas Gray",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20220702205403\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "One Draw Call UI",
    "name": "One Draw Call UI",
    "wordCount":  3284 ,
    "timeRequired": "PT16M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/one-draw-call-ui/",
    "datePublished": "2017-07-17T00:00Z",
    "dateModified": "2017-07-17T00:00Z",
    
    
    "description": ""
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
             
            
            
            
             
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/roadmap.html">Roadmap</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.github.io/themachinery-books/">Books</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/academic.html">Academic License</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220702205403/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.github.io/themachinery-books/" aria-label="Opens Books" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Books</span></a>
        <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>One Draw Call UI</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2017-07-17T00:00:00Z">
          Jul 17, 2017
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>Tobias wrote a nice post about <a href=" ../../post/ui-rendering-using-primitive-buffers/">the low level rendering of our UI</a>. If you haven&rsquo;t checked it out already, go ahead and do so, it introduces some interesting concepts.</p>
<p>To follow up, I wanted to say a little bit about the more high-level part of the UI, since that&rsquo;s what has been occupying my mind the last few weeks.</p>
<p>We&rsquo;ve decided to go with an immediate mode rather than a retained mode model for the UI. For a primer on to these two different models, have a look at <a href="http://web.archive.org/web/20220702205403/https://mollyrocket.com/861">Casey Muratori’s introductory talk</a> or <a href="http://web.archive.org/web/20220702205403/http://sol.gfxile.net/imgui/">this tutorial by Sol</a>.</p>
<p>The main reason why we like immediate mode, or IMGUI as it is often called, is that it avoids a lot of state synchronization between the UI and the underlying &ldquo;model&rdquo;. This tends to reduce boiler plate and produce code that is &ldquo;simpler&rdquo; (in some sense of the word). In an IMGUI it is easy to follow a control from the initial line of code that draws it all the way to the actual graphics that gets produced. In retained mode, your actions touch a bit of state that gets processed later and it can be hard to see the consequences (did this change cause a reflow?). We believe that there is great value to the transparency you get with the IMGUI model.</p>
<p>The ability to draw some quick controls deep inside a routine without worrying about who &ldquo;owns&rdquo; them and who needs to clean them up is also really nice.</p>
<h2 id="imgui-performance">IMGUI Performance</h2>
<p>The two main critiques that are usually brought up against IMGUIs are:</p>
<ul>
<li>
<p>It is good for simple UIs, but once you want to do <em>X</em> it doesn&rsquo;t work (where <em>X</em> can be a text editor, drag-and-drop, or something else).</p>
</li>
<li>
<p>It is inefficient to redraw the UI every frame.</p>
</li>
</ul>
<p>The first issue can be quite easily disproved by just doing <em>X</em> in an IMGUI. There are plenty of examples of people doing <em>X</em> for lots of different values of <em>X</em>.</p>
<p>But I wanted to say a little bit more about the second point.</p>
<p>First, I think people underestimate just how mind-numbingly fast computers are at doing simple operations. And most of the things we want to do in a UI are pretty simple. Putting some rects in a buffer. We can do <em>a lot</em> of that before it starts to become a problem.</p>
<p><em>If</em> it becomes a problem, there are a lot of things we can do to fix it. For example, optimizing a scrolled list to only process the items that are visible is trivial in an IMGUI. In contrast, in many retained UIs this requires switching to a completely different protocol, a <em>Virtual List View</em> or something similar.</p>
<p>Note that the usual implementation of a Virtual List View means putting an immediate model on top of the retained UI.</p>
<p>Caching can also be used in various ways. Expensive operations (if you have any) can be cached with hashed values of the input arguments. We can avoid updating the UI all together if there is no interaction with it. We can use separate UIs for different tabs, and only update the UIs of the tabs that the user interacts with, etc. We can also put a retained model on top of the immediate UI, keep expensive calculations in the retained model and only use the immediate UI for drawing. In fact, our docking system does just that, as you will see later.</p>
<p>The fact that it can be useful both to put an immediate model on top of a retained UI and a retained model on top of an immediate UI shows that both models have merit. But between these two approaches, I find the retained model on top of the immediate UI to be cleaner. Systems without state are simpler and its cleaner to have the simpler systems at the bottom of the stack.</p>
<p>Side note: I&rsquo;ve seen people propose to cache bitmaps for unchanging parts of the UI, but in my mind it seems simpler and better to just cache vertex and index buffers. A 1024 x 1024 bitmap is 3 MB in R8G8B8. You have to draw <em>a lot</em> of UI before you get 3 MB of vertex buffers. And retina displays give vertex buffers an even bigger advantage.</p>
<p>So caching can be used, if you need it, but computers are so fast that I don&rsquo;t really think that you do.</p>
<p>The important thing is that for me, performance is a <em>process</em> more than anything else. Pretty much anything can be made performant if you have the time to <em>analyze</em> where the performance problems are and then a<em>ddress</em> those issues using various tricks and techniques. This is where IMGUI has a big advantage, in my opinion. In an IMGUI, the code flow is so straightforward that it is really easy to see where the performance issues are and how to fix them. In a retained system, with a more complicated stack, this is much harder. Retained UIs may or may not have a theoretical performance advantage, in practice I think IMGUIs have the upper hand.</p>
<p>Case in point: I&rsquo;ve seen people struggle for weeks with making a performant log viewer in a retained system (HTML/Javascript). In an IMGUI, we just keep the strings in a buffer and draw as many as will fit on the screen. Less than an hour’s work, and the cost is just the cost of drawing the strings that fit on the screen, no matter how big the buffer is.</p>
<h2 id="single-draw-call">Single Draw Call</h2>
<p>If you&rsquo;ve been following the blog, by now you should know that one of the fun things we do at <em>Our Machinery</em> is to take a strong, elegant, but maybe a bit extremist idea about how to write code, and then push that idea as hard as we can to see if we can make it fly. (Previous hits are things such as writing all header files in C, not allow header files to include other header files, etc.)</p>
<p>The nice thing about this somewhat drastic development methodology is that it can pull you out of the rut of same-sameness, force your brain to think in new ways and move into some exciting, unexplored territory.</p>
<p>For the UI, one such idea that we went with is:</p>
<ul>
<li>Draw everything with a single draw call.</li>
</ul>
<p>This is an interesting idea, because it seems <em>almost</em> possible — the interesting space between the trivial and the impossible. Bindless APIs such as Vulkan lets us do this without massive texture atlassing, but there are still some issues that we need to solve, such as:</p>
<ul>
<li>Won&rsquo;t we need different shaders to draw textured and untextured primitives and other &ldquo;special&rdquo; things?</li>
<li>Don&rsquo;t we need different draw calls to handle different clipping/scissoring shapes?</li>
<li>What about overlapping windows and drop down menus?</li>
</ul>
<p>Tobias already addressed the first two items in his post, so I won&rsquo;t say more about them here. I&rsquo;ll talk more about overlapping windows below.</p>
<p>The nice thing about using a single draw call is that though it complicates things somewhat, in the sense that we have to find solutions to the problems above, it also <em>vastly</em> simplifies things.</p>
<p>Using a single draw call means that our drawing functions can just take a <em>vertex buffer</em> and an <em>index buffer</em> as input and write the drawn shapes directly into those buffers. The drawing functions don&rsquo;t have to worry about creating multiple draw calls, routing those draw calls to different shaders, etc.</p>
<p>We also don&rsquo;t have to worry about how to efficiently &ldquo;batch&rdquo; our drawing to keep the number of draw calls down (because the number of draw calls will always be exactly one). This is something you can really go crazy with and apply all kinds of advanced algorithms — dynamic texture atlassing, finding non-overlapping items that can be put in the same draw call, without worrying about draw order, etc. There is probably room enough for a couple of PhD theses there, and we don&rsquo;t have to do any of it. Nice!</p>
<h2 id="system-layers">System Layers</h2>
<p>Our UI implementation has three layers:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="UI Layers" src="../../images/ui-layers.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>UI Layers</h4>
    </figcaption>
  </figure>
<p>The <em>Drawing</em> layer just knows how to draw basic shapes such as rectangles, circles and text. The UI layer uses the drawing layer and user input to implement interactive controls, such as buttons and checkboxes. Finally, the docking layer puts those controls into dockable tabs that can be dragged and dropped between windows.</p>
<p>As stated above, the drawing functions just write data to vertex and index buffers. The API looks like this:</p>
<pre><code>struct tm_draw2d_buffer_t
{
    uint8_t *vbuffer;
    uint32_t vbytes;
    uint32_t *ibuffer;
    uint32_t in;
};

struct tm_drawing_api {
    void (*fill_rect)(struct tm_draw2d_buffer_t *buffer,
        const struct tm_draw2d_style_t *style, struct tm_rect_t r);
    ...
};
</code></pre>
<p>The <code>style</code> parameter contains settings for color, line width and other UI style options.
The drawing function will write data directly into the <code>vbuffer</code> and the <code>ibuffer</code> and increase the counters <code>vbytes</code> and <code>in</code> (number of indices) to reflect the written data. Note that there is no provision for automatically growing the buffers. It is the responsibility of the caller to make sure that the buffers have space enough for the data that gets written.</p>
<p>I like to separate the tasks of allocating memory and processing data as much as possible to make APIs more flexible. If we had put the memory allocation inside the <code>fill_rect()</code> function we would dictate that the <code>vbuffer</code> and <code>ibuffer</code> must be allocated individually on the heap, they couldn&rsquo;t be part of a larger structure. In addition, we would have to pass more parameters to the function, such as an allocation context, etc.</p>
<p>Keeping allocation and processing separate makes for a smaller, simpler API. I realize that this might be a controversial choice for people who are used to higher level APIs, but note that if you want a higher level API, you can just wrap the drawing functions in a library that also takes care of allocation. In fact, that&rsquo;s exactly what the UI layer does.</p>
<p>We could just write regular triangle vertices to the <code>vbuffer</code>, but as you can read in Tobias’ post, we try to be a bit more clever and compress the data that we write to use less memory. This compressed data then gets unpacked in the vertex shader.</p>
<p>Note that the drawing layer doesn&rsquo;t have any internal state at all, it only writes to the buffers passed in to the functions.</p>
<p>The <em>UI</em> layer is a <em>stateful</em> API in the sense that you create an <em>UI object</em> and then you draw controls (in immediate mode) into that object. The UI object state holds the <code>vbuffer</code> and <code>ibuffer</code> that the UI is drawn into, input state, and information about the currently active control.</p>
<p>The control drawing functions look like you might expect from an IMGUI:</p>
<pre><code>struct tm_ui_i {
    struct tm_ui_o *inst;
    bool (*button)(struct tm_ui_o *inst, struct tm_ui_style_t *style,
        struct tm_ui_button_t *c);
    ...
};
</code></pre>
<p>This draws a button based on the <code>style</code> settings using the drawing API. It also handles interaction with the control by detecting if the mouse button is pressed when over the object and returning <code>true</code> to the caller in that case.</p>
<p>Input events are explicitly fed to the UI system with a function like this:</p>
<pre><code>void (*feed_events)(struct tm_ui_o *inst, struct tm_input_event_t *events,
    uint32_t count, struct tm_vec2_t offset, struct tm_vec2_t scale);
</code></pre>
<p>This feeds a number of <code>tm_input_event_t</code> (our event format) to the UI for processing. The UI doesn&rsquo;t care where these events come from. <code>scale</code> and <code>offset</code> are used to translate from input coordinates (for mouse position) to UI coordinates. (The UI may be offset from the origo and scaled — for example for a retina display.)</p>
<p>Our UI library provides a set of standard controls (menus, buttons, scrollbars, etc), but it also provides low level access to the draw buffer, input state and active control state. This can be used to extend the system with new controls. Since the draw functions are just free standing functions without state it is easy to add your own custom drawing functions too, for drawing shapes that we haven&rsquo;t thought of. And since you also ultimately control the shader that the UI gets drawn with, you could even add completely new primitives with custom shader support. As long as the draw functions generate data that the shader understands, everything will work. This is kind of an extreme data-oriented approach, where things don&rsquo;t have meaning except in how they are tied together.</p>
<p>The <em>Docking</em> layer knows about multiple UIs, living in separate system windows. (The docking layer doesn&rsquo;t really care that they are &ldquo;system windows&rdquo;, they are just arbitrary rects as far as the docking layer is concerned.)</p>
<p>The docking system allows the user to create <em>Tab Views</em> and then supports dragging and dropping these tab views within a system window or between separate system windows. Tab wells are split automatically if you for example drop a tab on the right side of another tab. Note that the docking layer is in fact retained &ndash; it keeps a list of known tab views and windows, and items need to be explicitly added and removed from those lists. So this is an example of putting a retained layer on top of an underlying immediate UI.</p>
<p>When you want to render the UI, you call the docking system for each system window, and the docking system will return a list of the tabs that should be drawn in that window, together with the rect for each tab. The &ldquo;chrome&rdquo; for the tabs is drawn automatically by the docking system.</p>
<h2 id="handling-overlap">Handling Overlap</h2>
<p>When we draw primitives, we write them in-order to the vertex and index buffers. We don&rsquo;t use the depth buffer, so the items will be rendered in that order too. I.e., later items will be drawn on top of earlier items. This is usually what you want, but there are some situations where it can create problems:</p>
<ul>
<li>
<p>Reorderable items. In a UI with graph nodes or free floating &ldquo;windows&rdquo; we want the user to be able to bring an item &ldquo;to front&rdquo; by clicking on it.</p>
</li>
<li>
<p>Popup windows and drop-down menus. A drop-down menu belongs conceptually with the control that triggers it, and we want to draw it at the same time as that control. However, if we do that, the controls below it that are drawn later would appear on top of the menu items.</p>
</li>
</ul>
<p>Both of these issues could be solved by adding more draw calls, but we want to keep the purity of our idea of a single draw call.</p>
<p>Some IMGUI system have &ldquo;windows&rdquo; as a special concept — something conceptually distinct from other controls, but that doesn&rsquo;t feel right to me. I want &ldquo;windows&rdquo; to be just as other controls. That way the user can easily add new &ldquo;window&rdquo;-like things, such as graph nodes, and there is no special performance cost to having thousands of &ldquo;windows&rdquo;.</p>
<p>For the first issue, we simply make it the job of the caller to keep track of the order of the windows. Clicking on a <code>window()</code> control in the UI will return a <code>BRING_TO_FRONT</code> event to the caller. It is the responsibility of the caller to handle this event and rearrange the window list so that the activated window ends up last and gets drawn on top of the others. The same principle can be used for graph nodes or any other type of control where the draw order can be manipulated by the user.</p>
<p>Popup menus are handled by keeping track of an <code>overlay</code> drawing buffer. Popup controls that should appear on top of everything else are drawn into the <code>overlay</code> buffer instead of the regular drawing buffer. Before we send everything down to the GPU we merge the regular buffer and the overlay buffer, so that we still have a single draw call. Merging is simple, we just append all the overlay data at the end of the regular buffer. The only kind of patch-up we need to do is to offset the indices in the overlay buffer with the size of the regular buffer.</p>
<p>You might ask if having one overlay buffer is enough. Won&rsquo;t we need to have overlays for the overlays? I can think of situations that would require that — for example a popup-window could have a drop-down menu inside it. But I&rsquo;m not sure that is a UI design style we want to encourage. Anyway, I leave that open for now, if we decide that we need it later, it is easy enough to extend the system with more layers.</p>
<p>Overlap is an issue not only for drawing, but also for interaction. Consider the case when two buttons overlap. If the user clicks, we want the click to only affect the top button and not the button underneath it.</p>
<p>Overlapping buttons might seem like a crazy corner case of bad layouting that we won&rsquo;t have to worry about in practice, but it can actually happen quite easily. For example, if the UI has &ldquo;draggable&rdquo; items (graph nodes or &ldquo;windows&rdquo;), the user could drag one item on top of another, so that the buttons in the two items overlap. Another situation is when the user activates a dropdown menu. The items in the dropdown will overlap the buttons below. Remember, windows and popups are not special cases in our system, so this is just as much a problem as if you put two buttons directly on top of each other.</p>
<p>The problem with overlapping controls in an IMGUI is that while we are processing one control, there is <em>no way</em> for us to know if other controls that are drawn later will overlap it. We have no retained information and we don&rsquo;t know what the system might do after drawing this control. Thus, there is no way for us to tell if we should process a click on the control or not.</p>
<p>To handle this situation we need to introduce a frame delay, so that later controls have a chance to &ldquo;override&rdquo; our decision to react to an event, if those controls are drawn on top of us.</p>
<p>The way we do this in practice is like this: When a control is drawn we check if the mouse is on top of that control. If it is, we will set a <code>next_hover</code> state variable to the ID of the control. At the end of the frame we set the <code>hover</code> variable (which tracks which control the mouse is over) to the value of <code>next_hover</code>.</p>
<p>If a later control detects that the mouse is on top of it, it will change the value of <code>next_hover</code>. Thus, it is the <em>last</em> control that the mouse is over that controls the <code>hover</code> state. Note that this matches how controls are drawn, because it is also the last control drawn that appears on top. So this will ensure that <code>hover</code> matches what the user expects.</p>
<p>When there is a mouse click, only the control that matches the <code>hover</code> ID will process the click. Thus, clicks automatically get processed by the right (topmost) overlapping control, and only by that control.</p>
<p>To handle overlays (a dropdown menu appearing on top of other controls) we also set a <code>next_hover_layer</code> variable. A control can only overwrite the <code>next_hover</code> variable if its layer is equal to or greater than the <code>next_hover_layer</code> parameter. So if an item in the <em>overlay</em> buffer has set <code>next_hover</code>, no item drawn to the regular buffer will be able to change it. This gives the right interaction for items in overlays.</p>
<h2 id="preview">Preview</h2>
<p>Putting it all together, here’s a preview of our UI system showing some sample controls and the docking system. Note that the visuals are still a work-in-progress and haven’t gone through a polishing pass:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="UI Sample" src="../../images/ui-sample.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4>UI Sample</h4>
    </figcaption>
  </figure>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/authors/niklas" class="text-decoration-none">Niklas Gray</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220702205403/https://twitter.com/share?text=One%20Draw%20Call%20UI - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fone-draw-call-ui%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220702205403/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fone-draw-call-ui%2f&amp;description=One%20Draw%20Call%20UI" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/defaulting-to-zero/">Defaulting to Zero</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-06-26T00:00:00Z">
                      26 Jun 2017
                    </time>
                  </h6>
                  <p class="card-text"><p>The activity of programming is sometimes divided into high-level <em>system architecture</em> and low-level <em>implementation</em> — the …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/defaulting-to-zero/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">6 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/ui-rendering-using-primitive-buffers/">UI rendering using Primitive Buffers</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-06-19T00:00:00Z">
                      19 Jun 2017
                    </time>
                  </h6>
                  <p class="card-text"><p>Over the years we have used a lot of different frameworks for creating user interfaces for various editors: <em>wxWidgets</em>, …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/ui-rendering-using-primitive-buffers/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">8 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/the-importance-of-diversity/">The Importance of Diversity</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-06-12T00:00:00Z">
                      12 Jun 2017
                    </time>
                  </h6>
                  <p class="card-text"><p>If we look to nature, it’s easy to see that biodiversity has helped various species survive and adapt on Earth: from the …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/the-importance-of-diversity/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">4 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/one-draw-call-ui/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20220702205403/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20220702205403/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20220702205403/https://ourmachinery.com/cdn-cgi/l/email-protection#f88891969fb8978d8a95999b9091969d8a81d69b9795" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
         
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 20:54:03 Jul 02, 2022 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:53:41 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 71.485
  exclusion.robots: 0.104
  exclusion.robots.policy: 0.096
  RedisCDXSource: 0.993
  esindex: 0.009
  LoadShardBlock: 53.854 (3)
  PetaboxLoader3.datanode: 57.431 (5)
  CDXLines.iter: 14.063 (3)
  load_resource: 70.582
  PetaboxLoader3.resolve: 26.642
  loaddict: 37.141
-->