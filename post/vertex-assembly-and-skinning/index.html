











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="Describes how we do vertex assembly and skinning in The Machinery."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/machinery-logo.png"/>
  
  <meta name="twitter:title" content="Vertex Assembly and Skinning">
  <meta name="twitter:description" content="Describes how we do vertex assembly and skinning in The Machinery."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Vertex Assembly and Skinning · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/vertex-assembly-and-skinning/"/>
  
  <meta property="og:image" content="../../images/machinery-logo.png"/>
  
  
  <meta property="og:description" content="Describes how we do vertex assembly and skinning in The Machinery."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2019-09-17T00:00:00Z"/>
  

  <title>Vertex Assembly and Skinning &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" integrity="" print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" integrity="" print"/>
  

  
  
  <link href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    

  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js" integrity=""></script>
  <script type="text/javascript" src="../../js/page.min.js" integrity=""></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20210804194021/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20210804194021\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Tobias Persson",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20210804194021\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Vertex Assembly and Skinning",
    "name": "Vertex Assembly and Skinning",
    "wordCount":  1512 ,
    "timeRequired": "PT8M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/vertex-assembly-and-skinning/",
    "datePublished": "2019-09-17T00:00Z",
    "dateModified": "2019-09-17T00:00Z",
    
    
    "description": "Describes how we do vertex assembly and skinning in The Machinery."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                About
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/product.html" aria-label="Link The Machinery">The Machinery</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/about.html" aria-label="Link About Us">About Us</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/press.html" aria-label="Link Press Kit">Press Kit</a>
                </li>
                
              </ul>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Learning &amp; Support
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Link API Documentation" target="_blank">API Documentation</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/tutorials/" aria-label="Link Tutorials">Tutorials</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/videos.html" aria-label="Link Videos">Videos</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/samples.html" aria-label="Link Sample Projects">Sample Projects</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804194021/https://github.com/OurMachinery/themachinery-public/issues" aria-label="Link Issue Tracker" target="_blank">Issue Tracker</a>
                </li>
                
              </ul>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/tutorials/">Tutorials</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804194021/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/tutorials/" aria-label="Opens Tutorial" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Tutorials</span></a>
        <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Vertex Assembly and Skinning</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2019-09-17T00:00:00Z">
          Sep 17, 2019
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>Last summer I wrote a blog about the <a href=" ../../post/the-machinery-shader-system-part-3/">System’s
concept</a> of the shader system
that we have in The Machinery. Most of what was described in that post is still intact with what we
have today, except the anticipated variation selection rewrite that is nowadays handled using the
mentioned bitmask approach.</p>
<p>When I came up with the <code>tm_shader_system_o</code> concept my primary goal was to solve problems like:</p>
<ul>
<li>Generation and compilation of shader variations.</li>
<li>Runtime selection of which shader variation to use based on context.</li>
<li>Management of grouping of constants and resources with different update frequency needs.</li>
</ul>
<p>But since then I’ve also discovered some new use cases where <code>tm_shader_system_o</code> acts like an
abstract interface for data access, which from an engine architecture and shader authoring
perspective feels interesting enough to put down in writing.</p>
<p>So today, we will take a closer look at that, or precisely, how we handle vertex assembly and
skinning in The Machinery. I realize that this sounds like solved problems but I wanted to take a
few steps back and investigate if there are alternative approaches that gives more flexibility and
generates shader code that is easier to maintain compared to relying on the Input-Assembler stage
(IA) doing it for us.</p>
<h2 id="vertex-assembly">Vertex Assembly</h2>
<p>In The Machinery we don’t use classic vertex buffers for retrieving vertex data, instead we load all
data explicitly from <code>ByteAddressBuffers</code>. From a shader authoring point of view you rarely have to
think about how the various vertex channels (like position, texture coordinates, normals, etc) find
their way to the shader, as that code is hidden in a <code>tm_shader_system_o</code> that exposes a generic
interface for retrieving the data that looks something like this:</p>
<pre><code class="language-hlsl" data-lang="hlsl">tm_vertex_loader_context ctx;
init_vertex_loader_context(ctx, input.instance_id);

float4 local_pos = load_position(ctx, input.vertex_id, 0);
float2 uv = load_texcoord0(ctx, input.vertex_id, 0); 
</code></pre><p>Exactly what happens inside the <code>load_``*``()</code> functions depends on what the activated
<code>tm_shader_system_o</code> providing the implementations decides to do. While it could be as simple as
loading the data from one or many <code>ByteAddressBuffers</code>, it could just as well procedurally generate
the result based on some metadata looked up from the <code>instance_id</code> and <code>vertex_id</code>.</p>
<p>With this abstract interface approach for loading vertex data we get a lot of power and flexibility:</p>
<ul>
<li>
<p>We can freely load the data for <em>any</em> vertex of interest, not only the one we are currently
processing.</p>
</li>
<li>
<p>We can expose reading from the index buffer, allowing access to the full mesh data from any shader
stage.</p>
</li>
<li>
<p>We can encode, quantize or compress vertex data in any way that makes sense for the underlying
engine system.</p>
</li>
<li>
<p>We can gracefully handle cases of missing vertex data (e.g. if the shader tries to load data for a
certain uv-set that the underlying mesh data does not contain).</p>
</li>
<li>
<p>We can access any number of vertex data sets to easily support stuff like morph targets or
similar.</p>
</li>
</ul>
<p>This drastically simplifies the life for the regular shader authors who usually mostly care about
the surface appearance. They can now write a single shader, knowing that it will work fine whatever
engine object it gets assigned to.</p>
<p>Let’s take a quick peek at what one of the most basic Vertex Assembly interfaces might look like,
the replacement for retrieving vertex data from vertex buffers instead of going through the IA:</p>
<pre><code class="language-hlsl" data-lang="hlsl">#define VERTEX_SEMANTIC_POSITION 0
#define VERTEX_SEMANTIC_NORMAL 1
// ...
#define VERTEX_SEMANTIC_MAX_CHANNELS 16

struct tm_vertex_loader_context {
    // Bitflag indicating which vertex channels are active (upper 16 bits unused). 
    uint active_channels;
    // Total number of vertices per set in the vertex buffer.
    uint num_vertices;
    // Byte offset per channel.
    uint offsets[VERTEX_SEMANTIC_MAX_CHANNELS];
    // Byte stride per channel.
    uint strides[VERTEX_SEMANTIC_MAX_CHANNELS];
};
    
bool has_channel(tm_vertex_loader_context ctx, uint semantic) {
        return ctx.active_channels &amp; (1 &lt;&lt; semantic);
}

float4 load_position(tm_vertex_loader_context ctx, uint vertex_id, uint set) {
    ByteAddressBuffer buf = get_vertex_buffer_position_buffer();

    uint offset = (set * ctx.num_vertices + vertex_id) * 
        ctx.strides[VERTEX_SEMANTIC_POSITION] + 
        ctx.offsets[VERTEX_SEMANTIC_POSITION];

    return has_channel(ctx, VERTEX_SEMANTIC_POSITION) ? 
        float4(buf.Load3(offset), 1): float4(0,0,0,1);    
}

// ... the rest of the load_*() functions ...
</code></pre><p>The above code feels rather self-explanatory so I won’t spend any time going through it. Instead,
we’ll move on and take a look at our implementation of mesh skinning in The Machinery.</p>
<h2 id="skinning">Skinning</h2>
<p>Mesh skinning is typically implemented by associating each vertex to a fixed number of bone
influences transforming the vertex from its “bind” position to the skinned position. This is usually
handled by storing an <code>index</code> into an array of bone matrices and a <code>weight</code> in the vertex data for
each influencing bone.</p>
<p>In The Machinery I use a somewhat different approach that is less restricted when it comes to the
number of bones each vertex can be influenced by.</p>
<p>Instead of encoding bone indices and weights directly in the vertex data I store a single <code>uint</code>
that I refer to as <code>skin_data</code>. In its upper 8 bits I store the number of influencing bones for the
vertex and in the lower 24 bits I store a buffer offset to the beginning of an array holding:</p>
<pre><code class="language-hlsl" data-lang="hlsl">struct tm_bone_influence_t {
    uint index;
    float weight;
};
</code></pre><p>This allows us to support a varying number of bone influences per vertex (anywhere between 0-255
bones) without wasting any space, at the price of a memory indirection.</p>
<p>As for selecting the correct shader variation that applies the actual skinning transforms, that is
handled by activating a <code>tm_shader_system_o</code> called <code>skinning_system</code> on the engine side. The
<code>skinning_system</code> exposes an array of bone matrices to the shader that is indexed by
<code>tm_bone_influence_t::index</code> when looping over the influences.</p>
<p>As we rely on having per-pixel velocity available for TAA and other post effects, the bone matrices
array contains transform matrices for both current and last frame. To reduce unnecessary memory
shuffling we use a simple ping-pong scheme when updating the matrices:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Frame 0: w([f0-mat0, f0-mat1, f0-mat2, ...]) u([unused..])
Frame 1: u([f0-mat0, f0-mat1, f0-mat2, ...]) w([f1-mat0, f1-mat1, f1-mat2,...])
Frame 2: w([f2-mat0, f2-mat1, f2-mat1, ...]) u([f1-mat0, f1-mat1, f1-mat2,...])
...

w() -- written this frame
u() -- untocuhed from last frame
</code></pre></div><p>An <code>uint2</code> constant declared in the <code>skinning_system</code> is updated every frame with the byte offsets
to the start of the current and last frame bone arrays.</p>
<p>Final shader code for skinning becomes very straight forward, something like:</p>
<pre><code class="language-hlsl" data-lang="hlsl">struct tm_skin_header {        
    uint num_influences;
    uint address;
};

void init_skin_header(tm_vertex_loader_context ctx, inout tm_skin_header skin_header,
    uint vertex_id)
{
    if (has_channel(ctx, VERTEX_SEMANTIC_SKIN_DATA)) {
        uint offset = vertex_id * ctx.strides[VERTEX_SEMANTIC_SKIN_DATA] + 
            ctx.offsets[VERTEX_SEMANTIC_SKIN_DATA];
        uint skin_data = get_vertex_buffer_skin_data_buffer().Load(offset);
        skin_header.num_influences = (skin_data &gt;&gt; 24) &amp; 0xff;
        skin_header.address = skin_data &amp; 0xffffff;
    } else {
        skin_header.num_influences = 0;
    }
}

float4 skin_point(tm_skin_header skin_header, in float4 p, uint bone_offset, 
    ByteAddressBuffer bones)
{
    ByteAddressBuffer buf = get_vertex_buffer_skin_data_buffer();
    float4 res = float4(0,0,0,1);
    for (uint i=0; i!= skin_header.num_influences; ++i) {
        uint2 bone_and_weight = buf.Load2(skin_header.address + i * 8);
        res += asfloat(bone_and_weight.y) * 
            mul(p, load_mat44(bones, bone_offset + bone_and_weight.x * 64));
    }
    return res;
} 
</code></pre><h2 id="component-decoupling-using-tm_component_shader_system_i">Component decoupling using <code>tm_component_shader_system_i</code></h2>
<p>Before I wrap up, I’d like to touch a bit on engine system decoupling. In The Machinery we use an
<a href="http://web.archive.org/web/20210804194021/https://en.wikipedia.org/wiki/Entity_component_system">Entity Component System</a> (ECS), and, as
there is no monolithic core in The Machinery, everything can be extended through plugins. In the ECS
context that typically means that plugins expose new types of components.</p>
<p>A recurring situation when it comes to rendering in an ECS is that you have one component
responsible for issuing some kind of graphics work in the form of draw or dispatch calls, and
another component wanting to expose some kind of data to the shader assigned to those draw or
dispatch calls. But since the two components might be implemented in two completely different
plugins, we need this to work without the two knowing about each other.</p>
<p>A concrete example is the Skinning Component exposing the previously mentioned <code>tm_shader_system_o</code>
called <code>skinning_system</code>, to a shader used by a draw call issued from the Render Component. Also, we
don’t want to compute the bone transforms (going from bind pose to skinned pose) unless the Render
Component is in view from at least one of the cameras viewing the entity.</p>
<p>To handle this situation the plugin author wanting to expose a <code>tm_shader_system_o</code> can implement an
interface called <code>tm_component_shader_system_i</code> and register it under a name in our <a href=" ../../post/little-machines-working-together-part-2/">API
Registry</a>. This way the
Render Component (and others) can enumerate all registered <code>tm_component_shader_system_i</code> and only
call its update callback if the component survived view-frustum-culling from at least one camera.</p>
<p>The update callback returns a <code>tm_component_shader_system_t</code> that looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> tm_component_shader_system_t
{
    <span style="color:#75715e">// Bitmask describing for which viewers the system should be activated.
</span><span style="color:#75715e"></span>    uint64_t active_viewer_mask;
    <span style="color:#75715e">// Shader system to enable.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> tm_shader_system_o <span style="color:#f92672">*</span>system;
    <span style="color:#75715e">// Optional constant buffer needed by shader system.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> tm_shader_constant_buffer_instance_t <span style="color:#f92672">*</span>constants;
    <span style="color:#75715e">// Optional resource binder needed by shader system.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> tm_shader_resource_binder_instance_t <span style="color:#f92672">*</span>resources;
} tm_component_shader_system_t;   
</code></pre></div><p>The <code>active_viewer_mask</code> allows the component to decide for which viewer types (regular viewport
cameras, shadow mapping cameras, etc) the system should be activated.</p>
<p>So far, this looks like a fairly promising and efficient way for handling component to component
communication without coupling when it comes to rendering. In case you’ve missed it, I blogged about
<a href=" ../../post/ecs-and-rendering/">ECS and rendering</a> last autumn, although in that
post I mainly focused on exposing viewer- and scene global data to lots of draw- and dispatch calls.</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/authors/tobias" class="text-decoration-none">Tobias Persson</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804194021/https://twitter.com/share?text=Vertex%20Assembly%20and%20Skinning - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fvertex-assembly-and-skinning%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804194021/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fvertex-assembly-and-skinning%2f&amp;description=Vertex%20Assembly%20and%20Skinning" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/data-structures-part-2-indices/" class="text-decoration-none"><img src="../../images/ds2-index.jpg" class="card-img-top" alt="Data Structures Part 2: Indices"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/data-structures-part-2-indices/">Data Structures Part 2: Indices</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2019-08-14T00:00:00Z">
                      14 Aug 2019
                    </time>
                  </h6>
                  <p class="card-text"><p>In my <a href=" ../../post/data-structures-part-1-bulk-data/">last post</a>, I concluded that
the best way to store <em>most</em> things is to use a large unsorted array. I sneakily avoided …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/data-structures-part-2-indices/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">22 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/data-structures-part-1-bulk-data/" class="text-decoration-none"><img src="../../images/dsp1-bulk-data.jpg" class="card-img-top" alt=" Data Structures Part 1: Bulk Data "></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/data-structures-part-1-bulk-data/"> Data Structures Part 1: Bulk Data </a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2019-07-23T00:00:00Z">
                      23 Jul 2019
                    </time>
                  </h6>
                  <p class="card-text"><p>Any programmer can benefit from some understanding of different <a href="http://web.archive.org/web/20210804194021/https://en.wikipedia.org/wiki/Data_structure">data
structures</a> and how to analyze their performance. …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/data-structures-part-1-bulk-data/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">25 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/summertime-rolls/">Summertime Rolls</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2019-06-24T00:00:00Z">
                      24 Jun 2019
                    </time>
                  </h6>
                  <p class="card-text"><p>Hey Friends, it’s that time of year again, summer break! The whole team will be taking some time off
here and there …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/summertime-rolls/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">1 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/vertex-assembly-and-skinning/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20210804194021/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804194021/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/cdn-cgi/l/email-protection#84f4edeae3c4ebf1f6e9e5e7ecedeae1f6fdaae7ebe9" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
        <p>&copy; Our Machinery 2021 <a style="text-decoration:none; margin-left:1em;" href="http://web.archive.org/web/20210804194021/https://ourmachinery.com/privacy.html">Privacy Policy</a></p>
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 19:40:21 Aug 04, 2021 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:52:37 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 2051.046
  exclusion.robots: 0.078
  exclusion.robots.policy: 0.071
  cdx.remote: 0.059
  esindex: 0.007
  LoadShardBlock: 89.666 (3)
  PetaboxLoader3.datanode: 188.865 (4)
  CDXLines.iter: 14.973 (3)
  load_resource: 207.455
  PetaboxLoader3.resolve: 46.697
-->