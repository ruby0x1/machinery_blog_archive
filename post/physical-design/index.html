











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content=""/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/machinery-logo.png"/>
  
  <meta name="twitter:title" content="Physical Design of The Machinery">
  <meta name="twitter:description" content=""/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Physical Design of The Machinery · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/physical-design/"/>
  
  <meta property="og:image" content="../../images/machinery-logo.png"/>
  
  
  <meta property="og:description" content=""/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2017-04-03T17:14:10+02:00"/>
  

  <title>Physical Design of The Machinery &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" media="screen, print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" media="screen, print"/>
  

  
  
  <link href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    ga('set', 'anonymizeIp', true);
    
  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="../../js/page.min.js?v=1.16"></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20220526205643/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20220526205643\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Niklas Gray",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20220526205643\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Physical Design of The Machinery",
    "name": "Physical Design of The Machinery",
    "wordCount":  2268 ,
    "timeRequired": "PT11M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/physical-design/",
    "datePublished": "2017-04-03T17:14Z",
    "dateModified": "2017-04-03T17:14Z",
    
    
    "description": ""
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
             
            
            
            
             
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/roadmap.html">Roadmap</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.github.io/themachinery-books/">Books</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/academic.html">Academic License</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220526205643/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.github.io/themachinery-books/" aria-label="Opens Books" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Books</span></a>
        <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Physical Design of The Machinery</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2017-04-03T17:14:10+02:00">
          Apr 3, 2017
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>At Our Machinery we have one simple rule that governs the physical design of the code:</p>
<p><strong>Header files (.h) cannot include other header files</strong></p>
<p>In other words, header files cannot depend on other header files for the types they need. (Except for <code>&lt;inttypes.h&gt;</code> and <code>&lt;stdboolh.&gt;</code> , we make exceptions for those to get the standard <code>uint32_t</code> and <code>bool</code> types.)</p>
<p>This is a pretty extreme choice. Let’s unpack why we made this decision and how we make it work.</p>
<h1 id="physical-design">Physical design</h1>
<p>To begin with, if you are not familiar with the term, the <em>physical design</em> of a C++ project refers to how the code is broken down into individual <code>.h</code> and <code>.cpp</code> files and how those files are organized on disk — which files include which others, etc. It is related to, but separate from, the <em>logical design</em> which refers to how the components of the system are connected and interact.</p>
<p>Just as with <em>logical design</em>, the primary goal of <em>physical design</em> is to reduce coupling. We want to minimize the dependencies, so that changes in one file don’t have a big impact on other files.</p>
<p>Bad physical design is easy to spot. It happens whenever <code>.cpp</code> files pull in a lot of <code>.h</code> files that they don’t need. Most of the time this happens indirectly. The <code>.cpp</code> file includes something it needs. Then that thing includes more stuff. And the stuff includes even more stuff — completely unrelated to the original problem. Expanding the <code>#includes</code>  in such a project can be both scary and enlightening. A few innocent <code>#includes</code> sometimes expand to megabytes of header data once all the recursive inclusion is resolved. This has a number of bad effects:</p>
<ul>
<li>Compiles are slow. (Modern compilers are smart about caching header data, but there are limits to what they can do.)</li>
<li>Making changes in single header files causes the whole project to recompile.</li>
<li>You sometimes get weird and annoying errors because of name conflicts in the headers you’re unwittingly pulling in (<code>#define min</code> in <code>&lt;windows.h&gt;</code> is a classic).</li>
</ul>
<p>All of these things make it harder and more cumbersome to make code changes, which is the worst thing you can do to a software project. Software needs to be nimble to stay alive. If the code gets too heavy you need an army of programmers to move it along, which is neither efficient nor fun.</p>
<p>A large part of the reason why people are drawn to scripting languages is the ability to iterate over the code quickly, to make changes and immediately see the results. At Our Machinery, we believe the similar things are possible with high-performance static languages, if you just set things up the right way.</p>
<h1 id="fixing-physical-design">Fixing physical design</h1>
<p>Bad physical design tends to be a creeping issue. In the beginning, when your project is small, compile times are good no matter what, so who cares. When the project gets so big that it starts to be annoying, it is often too late to do anything about it.</p>
<p>Fixing a bad physical design is hard, even if you have <a href="http://web.archive.org/web/20220526205643/https://bitsquid.blogspot.se/2011/10/caring-by-sharing-header-hero.html">a tool</a> that can pinpoint where you should focus your efforts. It typically goes something like this:</p>
<ul>
<li>Remove a single <code>#include</code> statement.</li>
<li>Insert the forward declarations that might now be needed.</li>
<li>Insert new <code>#include</code> statements that might now be needed (because those files were previously included indirectly by the line you just removed).</li>
<li>If there are any dependencies that can’t be resolved with forward declarations — refactor the code (this could be an arbitrarily complex task, depending on how gnarly the code is).</li>
<li>Make sure the code still compiles.</li>
<li>Make sure the code still compiles <em>on every supported platform and in every supported configuration</em>.</li>
<li>If you had to refactor the code, run tests to make sure you didn’t introduce any new bugs.</li>
</ul>
<p>That’s a lot of work to remove one single <code>#include</code>  statement. And of course, removing a single <code>#include</code> doesn’t have any measurable effect on the compile time or anything else that people care about. You have to repeat this, again and again, hundreds, maybe thousands of times before you start seeing results. It’s thankless, unrewarding grunt work. And if the physical design is already bad, all those compiles you need to do to check if things still work will take a really long time.</p>
<p>Also, while you are slaving away at this, the rest of the team is doing some other work, happily adding new <code>#include</code> statements everywhere. There is a reasonable chance that over the next few months, all the work you just did will be undone.</p>
<p>Physical design is really easy to screw up, but requires concentrated effort and hard work to fix. This means that time and human nature will pretty much guarantee that you are screwed. It’s simple thermodynamics.</p>
<p>So in a lot of large codebases, people essentially just give up and switch to <a href="http://web.archive.org/web/20220526205643/https://en.wikipedia.org/wiki/Single_Compilation_Unit">unity builds</a> or something. Once you are in that hole, it might even be the right decision, but that’s not where we want to end up with Our Machinery.</p>
<h1 id="necessity-is-the-mother-of-prevention">Necessity is the mother of prevention</h1>
<p>Since the problem is so hard to fix, we need to stop it before it happens. We need rules that people can follow to avoid getting into this mess. But if you look online, most of the rules you find will boil down to something like:</p>
<blockquote>
<p>Don’t include more header files than you need</p>
</blockquote>
<p>That is good <em>advice</em>, but it as a rule it sucks. It’s too vague. It doesn’t tell you what to do or how to solve problems you encounter. It’s not verifiable. A rule like that will not stop people from just adding <code>#includes</code> until the code compiles. After all, that’s what they “need”. We have:</p>
<p>Vague rules + no enforcement + path of least resistance + human nature → chaos</p>
<p>Rules should be clear enough that it is obvious if the code follows them or not. Even better, they should be machine verifiable. That way, we can just put the rule in the pre-commit hook and be <em>certain</em> that it is always followed.</p>
<p>This is why we use <code>clang-format</code> to format our code. It doesn’t do exactly what we want, but it is close enough that having automatic formatting is worth the trade-off.</p>
<p>(If you want to know — our main gripe with <code>clang-format</code> is that it insists on left flushing pre-processor directives instead of indenting them with the rest of the code. I find this a terrible, unreadable practice — especially when you have nested levels of <code>#ifs</code>  and <code>#elses</code> . Maybe we’ll make a patch for it some day, unless someone beats us to the punch.)</p>
<h1 id="cutting-the-gordian-knot">Cutting the Gordian knot</h1>
<p>All that exposition explains why we went with a simple, unambigous and easy to remember rule:</p>
<p><strong>Header files (.h) cannot include other header files</strong> (except for <code>&lt;inttypes.h&gt;</code> and <code>&lt;stdbool.h&gt;</code>)</p>
<p>This rule is simple and clear enough to be machine verifiable and it completely solves the problem of physical design.</p>
<blockquote>
<p>Note: Even with this rule we can still have <code>.cpp</code> files that include headers they don’t need, but that’s not really a big problem. If we eliminate headers including other headers we don’t get the big expanding tree of includes — everything stays pretty contained. And it’s easy to remove <code>#includes</code> in a single <code>.cpp</code> file and check if that file still compiles — we don’t have to touch or compile any other part of the project. In fact, it is so easy that we can automate the process.</p>
</blockquote>
<p>Not allowing <em>any</em> header file inclusions is a drastic choice, but that is also what I like about it. I think a lot can be learned by picking an interesting idea or philosophy and see just how far we can push it. Even if we don’t make it all the way we will learn a lot of new things by trying.</p>
<p>But does the rule work in practice? Can we actually write header files that don’t depend on types defined in other header files? Let’s look some of the problems you encounter when trying to do that and how we deal with them.</p>
<h2 id="classes">Classes</h2>
<p>Classes are tricky. If you write your classes following a strict <a href="http://web.archive.org/web/20220526205643/https://en.wikipedia.org/wiki/Opaque_pointer">PIMPL idiom</a> and only put abstract interfaces in the headers you might be able to get away with just forward declarations. But that is kind of a complicated way to write C++. And as soon as you want concrete classes, inheritance, templates or inline functions you start to get into trouble.</p>
<p>Our solution to this is simple — we don’t use classes. Our header files are written in plain old C, C99 to be precise. The <em>implementation</em> files can be either C or C++ — whatever makes sense for that particular piece of code — but the APIs and interfaces are strict C.  We have several good reasons for this approach, which I will detail in a future blog post, but the main one is that it gives us better logical decoupling. And presto, we get better physical decoupling too, as we don’t need to worry about class dependencies in the header files.</p>
<h2 id="templates">Templates</h2>
<p>One of the reasons why we allow C++ in the implementation files is that templates are a very convenient way of solving certain programming problems. But how can we use templates without having headers include other headers?</p>
<p>First, the templates are only used in the <code>.cpp</code> files. Thus, the <code>.h</code>  files never need to include them. Second, the templates themselves are written in <code>.inl</code> files rather than <code>.h</code> files, and we don’t have any rule against <code>.inl</code> files including other <code>.inl</code> files. In other words, you can write a template that depends on another template.</p>
<p>This may seem like just semantic trickery — if we allow <code>.inl</code> file to include <code>.inl</code> files aren’t we just recreating the whole rat’s nest again, just with <code>.inl</code> files instead of <code>.h</code> files?</p>
<p>Actually, I don’t think so. We use <code>.inl</code> files very sparingly — only for template code. We’re in general very conservative about using “advanced C++” features and not at all into template-metaprogramming with trait classes, etc. But templates are convenient for things like arrays and hashes. In fact, we currently have exactly two <code>.inl</code> files in the project — <code>array.inl</code> and <code>hash.inl</code> . Granted, the project is still small, but we don’t expect to add many more.</p>
<h2 id="inlined-functions">Inlined functions</h2>
<p>What about inlined functions then? Don’t we want to use inlined functions in our header files to improve performance? And in that case, don’t we want to allow headers to include other headers, so that one inlined function can call another and have all those calls optimized away?</p>
<p>Not really. Inline functions are a C++ solution to a C++ problem. “Good C++ design” encourages having many layers of abstraction with simple functions doing trivial things. Then it promises that through inlined functions and optimizing compilers, all those levels of abstraction will be cost-free, since everything will compile down to a few simple assembly instructions. And it actually works most of the time.</p>
<p>But we question the benefits of all those abstraction layers in the first place. As anyone who has tried to step into STL code in the debugger knows, adding abstraction layers does not necessarily make the code easier to understand. On the contrary it can sometimes make you feel lost in a maze, wondering where <em>the real code</em> is. What is the benefit of abstraction if it doesn’t help programmers?</p>
<p>Sure, if you have an interface function <code>Vector3::get_x()</code> , then that function better be inlined, because otherwise you are paying a heavy price for just retrieving a float. But we prefer to write meatier methods in the APIs, that operate on more than one item at a time. For example, instead of <code>get_x(),</code> maybe we have a function for getting the positions of all objects:</p>
<pre><code>// Retrieves pointers to the arrays of x, y and z positions and returns
// the total number of items in those arrays.
uint32_t get_positions(float **x, float **y, float **z);
</code></pre>
<p>This is a part of our <a href="http://web.archive.org/web/20220526205643/https://en.wikipedia.org/wiki/Data-oriented_design">data-oriented design</a> philosophy: where there is one, there are many.</p>
<p>With “meatier” functions in the API we don’t have to worry about the function call overhead, because we won’t be calling them a million times. Another interesting thing to note is that while we have to pay the cost of the functional call, this API style makes much more important optimizations possible. For example, with direct access to the coordinate arrays, we can write our processing code using SIMD instructions and gain an immediate 4x speed boost.</p>
<h2 id="os-types">OS types</h2>
<p>What about OS types then, such as <code>HANDLE</code> , don’t we need to include <code>&lt;windows.h&gt;</code> in order to deal with them?</p>
<p>In our API, we represent all OS types as opaque collections of bits:</p>
<pre><code>struct tm_file_o {uint64_t opaque;};
</code></pre>
<p>Then in the implementation files we just <code>memcpy()</code> our <code>HANDLE</code> , or whatever the type is for a particular OS, in and out of the <code>tm_file_o</code> . We make sure to make the <code>tm_file_o</code>  structure “big enough” to fit the file handle type in all our supported OSes.</p>
<h1 id="conclusion">Conclusion</h1>
<p>So far, our decision not to allow header files to include other header files has been a great one. Not only has it kept compile times and dependencies down, but we have also found that the strictness that it imposes on the physical design tends to make the logical design clearer and simpler.</p>
<p>We haven’t yet encountered a situation where this approach has led to trouble. We will continue to use it and try to take it all the way to the finished product.</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/authors/niklas" class="text-decoration-none">Niklas Gray</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220526205643/https://twitter.com/share?text=Physical%20Design%20of%20The%20Machinery - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fphysical-design%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220526205643/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fphysical-design%2f&amp;description=Physical%20Design%20of%20The%20Machinery" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/day-1-blog/">Day 1 Blog</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-03-22T14:58:45+01:00">
                      22 Mar 2017
                    </time>
                  </h6>
                  <p class="card-text"><p>Hello and welcome to Our Machinery.</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/day-1-blog/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">1 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/physical-design/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20220526205643/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20220526205643/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20220526205643/https://ourmachinery.com/cdn-cgi/l/email-protection#1e6e7770795e716b6c737f7d7677707b6c67307d7173" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
         
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 20:56:43 May 26, 2022 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:54:01 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 134.879
  exclusion.robots: 0.089
  exclusion.robots.policy: 0.081
  RedisCDXSource: 3.253
  esindex: 0.008
  LoadShardBlock: 103.413 (3)
  PetaboxLoader3.datanode: 151.486 (4)
  CDXLines.iter: 23.816 (3)
  load_resource: 115.425
  PetaboxLoader3.resolve: 23.466
-->