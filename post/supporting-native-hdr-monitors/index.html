











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="Supporting monitors with native HDR support."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/hdr__gamut.png"/>
  
  <meta name="twitter:title" content="Supporting Native HDR Monitors">
  <meta name="twitter:description" content="Supporting monitors with native HDR support."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Supporting Native HDR Monitors · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/supporting-native-hdr-monitors/"/>
  
  <meta property="og:image" content="../../images/hdr__gamut.png"/>
  
  
  <meta property="og:description" content="Supporting monitors with native HDR support."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2021-06-15T00:00:00Z"/>
  

  <title>Supporting Native HDR Monitors &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" integrity="" print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" integrity="" print"/>
  

  
  
  <link href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    

  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js" integrity=""></script>
  <script type="text/javascript" src="../../js/page.min.js" integrity=""></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20210804193248/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20210804193248\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Frank de Jong",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20210804193248\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Supporting Native HDR Monitors",
    "name": "Supporting Native HDR Monitors",
    "wordCount":  2555 ,
    "timeRequired": "PT12M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/supporting-native-hdr-monitors/",
    "datePublished": "2021-06-15T00:00Z",
    "dateModified": "2021-06-15T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://web.archive.org/web/20210804193248/https://ourmachinery.com/hdr__gamut.png"
    },
    
    
    "description": "Supporting monitors with native HDR support."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                About
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/product.html" aria-label="Link The Machinery">The Machinery</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/about.html" aria-label="Link About Us">About Us</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/press.html" aria-label="Link Press Kit">Press Kit</a>
                </li>
                
              </ul>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Learning &amp; Support
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Link API Documentation" target="_blank">API Documentation</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/tutorials/" aria-label="Link Tutorials">Tutorials</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/videos.html" aria-label="Link Videos">Videos</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/samples.html" aria-label="Link Sample Projects">Sample Projects</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804193248/https://github.com/OurMachinery/themachinery-public/issues" aria-label="Link Issue Tracker" target="_blank">Issue Tracker</a>
                </li>
                
              </ul>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/tutorials/">Tutorials</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804193248/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/tutorials/" aria-label="Opens Tutorial" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Tutorials</span></a>
        <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Supporting Native HDR Monitors</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2021-06-15T00:00:00Z">
          Jun 15, 2021
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>Monitors that can display HDR color spaces are not very common on gaming PCs. Nevertheless, I bought
one when creating my workstation in order to add support for fancy things like 12-bit color depth
and HDR10 output. I never actually implemented this during university, but during my internship at
Our Machinery, I took the opportunity during several “Fun Fridays” to add support. This blog post
details how the implementation works on a theoretical level, the practical aspects of the
implementation, and the problems I ran into.</p>
<h2 id="human-color-perception">Human color perception</h2>
<p>Humans can only see a small part of the electromagnetic spectrum (380nm to 760nm) and we don’t even
view that uniformly. Instead, our eyes have cone cells that react to different wavelengths of light
to produce the perception of color. We have three types of them: short (<strong>S</strong>), medium (<strong>M</strong>), and
long (<strong>L</strong>). These don’t map to specific colors, but instead, they each respond to a range of
colors:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block mx-auto" alt="Response of each cone cell type to different wavelengths of light. Picture from Wikipedia: https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/Cone-fundamentals-with-srgb-spectrum.svg/1280px-Cone-fundamentals-with-srgb-spectrum.svg.png" src="../../images/hdr__cone_cells.png">
    <figcaption class="figure-caption fs-5">
        <h4>Response of each cone cell type to different wavelengths of light. Picture from <a href="http://web.archive.org/web/20210804193248/https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/Cone-fundamentals-with-srgb-spectrum.svg/1280px-Cone-fundamentals-with-srgb-spectrum.svg.png">Wikipedia</a>.</h4>
    </figcaption>
</figure>
<p>Notice how the green wavelengths have the most overlap with all cones. This means that we can see
more shades of green than any other color.  One other property of human vision that is useful to
know is that we perceive brightness differently than it is mathematically. We’re better at seeing
differences in darker colors than in bright colors. This relationship roughly follows a power curve.
Human vision is more complex than this, but this is all we need to know for now.</p>
<h2 id="standardization-of-color">Standardization of color</h2>
<p>When trying to support any hardware feature, it’s always nice to work with some sort of standard.
Color is no different, and has been somewhat standardized since 1931. Most people are familiar with
sRGB colors, but the sRGB color space only covers a subset of the colors that the human eye can see.
To be able to compare different color spaces, it is useful to have a reference space that is big
enough to encompass the full range of human perception. For this, we turn to the CIE-XYZ color space
and the accompanying CIE-xyY space.</p>
<p>CIE-XYZ (Commission Internationale de l’éclairage XYZ) is a color space designed to capture the
entire visible light spectrum in a linear space. This has the advantage that it’s easier to do math
in this color space as multiplying any color by two will double its brightness. This color space is
however a bit abstract. Y stands for luminance, which is a very useful property, Z is quasi-equal to
blue, which is a bit hard to reason about, and X is a mix of the three CIE-RGB curves, which is even
less helpful to reason about. Therefore we generally don’t visualize this space directly but instead
convert it into CIE-xyY space.</p>
<p>We are typically interested in visualizing chromaticity when using the CIE-xyY color space.
Therefore the main two components (x and y) which represent normalized chromaticity are visualized,
whilst luminance (Y) is set to a fixed value for the entire image.</p>
<p>Converting from CIE-XYZ to CIE-xyY is easy enough:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">tm_vec3_t <span style="color:#a6e22e">cie_xyz_to_cie_xyy</span>(tm_vec3_t color)
{
    <span style="color:#66d9ef">float</span> x <span style="color:#f92672">=</span> color.x <span style="color:#f92672">/</span> (color.x <span style="color:#f92672">+</span> color.y <span style="color:#f92672">+</span> color.z);
    <span style="color:#66d9ef">float</span> y <span style="color:#f92672">=</span> color.y;
    <span style="color:#66d9ef">float</span> z <span style="color:#f92672">=</span> color.z <span style="color:#f92672">/</span> (color.x <span style="color:#f92672">+</span> color.y <span style="color:#f92672">+</span> color.z);
    <span style="color:#66d9ef">return</span> (tm_vec3_t) { x, y, z };
}
</code></pre></div><p>If we set luminance (<strong>Y</strong>) to a constant value, we can plot the x and y on a normalized graph to
show the gamut of human vision. This is the common background used to compare the color gamuts of
different color spaces and is known as the CIE-1931 chromaticity diagram.</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="The human vision gamut." src="../../images/hdr__gamut.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>The human vision gamut.</h4>
    </figcaption>
  </figure>
<p>In this diagram, I’ve visualized two color primaries. The small triangle is BT.709 and the larger
one is BT.2020. Note that neither of them fully encompasses the entire visible light spectrum, but
BT.2020 has a much wider gamut. If you want to know more about the CIE-XYZ color space; I recommend
watching: <a href="http://web.archive.org/web/20210804193248/https://www.youtube.com/watch?v=AS1OHMW873s">“RGB to XYZ: The Science and History of Color&quot; by John
Austin</a>.</p>
<h2 id="color-primaries">Color primaries</h2>
<p>Color primaries define the pure colors in a given color model, i.e. what is meant by pure red,
green, and blue for a given color space. It also defines the color space’s white point, which is the
pure white color of the color space. These color primaries are defined using the coordinates of the
3 corners of the color gamut in the CIE-xyY color space and are generally a subset of the visible
color spectrum, but not always. A few common color primaries are:</p>
<ul>
<li>BT.709 (Rec.709), the most common one. This is often just referred to as sRGB and is the standard
for HDTV.</li>
<li>AdobeRGB. This has a wider gamut than BT.709 and was developed by Adobe to encompass most colors
available on printers.</li>
<li>BT.2020 (Rec.2020). This is the standard for UHD TV, often just referred to as HDR10. Note that
this requires 10-bit color depth.</li>
<li>ACES (AP0). This was created by various industry professionals under the auspices of the Academy
of Motion Picture Arts and Sciences. It encompasses the entire visible color gamut and also
requires 10-bit color depth.</li>
</ul>
<p>BT.709 is supported everywhere so we traditionally use it in games. BT.2020 is supported by some
monitors (emulated or natively), but not many games actually support it. This is the one we’ll be
focusing on.</p>
<p>Note that it’s not useful to support wider gamuts on monitors without at least 10-bit color depth
because when you display a color gradient with too few bits you get banding:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Banding of color values on low bit depths. In the left two images, only 3 bits are used for the red channel. In the right image, 8 bits are used." src="../../images/hdr__banding.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Banding of color values on low bit depths. In the left two images, only 3 bits are used for the red channel. In the right image, 8 bits are used.</h4>
    </figcaption>
  </figure>
<p>This example is rather extreme, but things like this can easily happen when rendering in an HDR
space without deep color support.</p>
<h1 id="transfer-functions">Transfer functions</h1>
<p>Remember that we can distinguish darker colors better than brighter ones? This is where transfer
functions come in. The original sRGB transfer function was used for CRT monitors to compensate for
its input-output characteristics, but nowadays we use them for better color encoding. This is
because the power curve of the transfer function will dedicate more bits to the darker shades. The
transfer function is often called “gamma correction&quot; and is different depending on the color space.
Often times, the combination of color primaries and a transfer function is referred to as a color
space. To give a few examples:</p>
<ul>
<li>BT.709 is often coupled with the sRGB transfer function in order to create the sRGB color space.
This is how most game engines define their LDR color output space. Instead of the official sRGB
transfer function, a power curve of 2.2 was often used as an approximation.</li>
<li>BT.2020 is often coupled with either the ST2084 PQ or HLG transfer function. The most common one
is ST2084 PQ.</li>
<li>AdobeRGB has its own transfer function, also called AdobeRGB for clarity :)</li>
</ul>
<h1 id="the-machinery-solution">The Machinery solution</h1>
<p>Most HDR solutions I’ve come across support only one or two HDR standards. This didn’t seem very
flexible to me, especially since Vulkan supports a wide range of color spaces. I wanted to support
at least all of those. I decided to stick close to the <a href="http://web.archive.org/web/20210804193248/https://www.khronos.org/registry/DataFormat/specs/1.3/dataformat.1.3.html#_color_space_composition">Khronos color
space</a>
definition which defines a color space with the three parameters discussed earlier. I also added two
extra fields that help with picking the right color space implementation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Defines how to interpret decoded numerical color values.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> tm_color_space_desc_t
{
    <span style="color:#75715e">// The interpretation of each channel.
</span><span style="color:#75715e"></span>    tm_color_space_color_primary color_primary;

    <span style="color:#75715e">// How to encode the color from numerical linear to non-linear.
</span><span style="color:#75715e"></span>    tm_color_space_transfer_function transfer_function;

    <span style="color:#75715e">// The color model.
</span><span style="color:#75715e"></span>    tm_color_space_color_model color_model;

    <span style="color:#75715e">// The number of bits across all channels.
</span><span style="color:#75715e"></span>    uint8_t color_depth;

    <span style="color:#75715e">// Whether the transfer function is built-in.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> auto_transfer_function;
} tm_color_space_desc_t;
</code></pre></div><p>Here, the color model describes how channels map to additive colors. For a swap chain, this value
will always be <code>TM_COLOR_SPACE_COLOR_MODEL__RGB</code>, but supporting other models is very useful as you
can convert entire images to HSL or Y`CbCr without having to think about the conversion yourself,
reducing the risk of errors.</p>
<p>Most graphics APIs support sRGB encoded back buffers or even general sRGB encoded image formats.
When writing to these images, the input is expected to be in linear (BT.709) space, but the driver
will apply the sRGB transfer function for storage.</p>
<p><code>auto_transfer_function</code> was added specifically to support these formats, which would otherwise be
identical to their linear counterparts. As an example, here are the color spaces my monitor
supports:</p>
<figure class"figure d-block">
    <div style="width: 126%; position: relative; left: 50%; transform: translateX(-50%); border: solid #ccc 1px; padding: 5px;">
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Primary</th>
                    <th>Transfer<br>Function</th>
                    <th>Color<br>model</th>
                    <th>Bit-depth</th>
                    <th>Automatic<br>transfer<br>function</th>
                    <th><a href="http://web.archive.org/web/20210804193248/https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VkSurfaceFormatKHR.html">VkSurfaceFormatKHR</a>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>BT.709</td>
                    <td>sRGB</td>
                    <td>RGB</td>
                    <td>24</td>
                    <td>false</td>
                    <td><code>VK_COLOR_SPACE_SRGB_NONLINEAR_KHR</code><br><code>VK_FORMAT_B8G8R8A8_UNORM</code></td>
                </tr>
                <tr>
                    <td>BT.709</td>
                    <td>sRGB</td>
                    <td>RGB</td>
                    <td>24</td>
                    <td>true</td>
                    <td><code>VK_COLOR_SPACE_SRGB_NONLINEAR_KHR</code><br><code>VK_FORMAT_B8G8R8A8_SRGB</code></td>
                </tr>
                <tr>
                    <td>BT.709</td>
                    <td>Linear</td>
                    <td>RGB</td>
                    <td>48</td>
                    <td>false</td>
                    <td><code>VK_COLOR_SPACE_EXTENDED_SRGB_LINEAR</code><br><code>VK_FORMAT_R16G16B16A16_SFLOAT</code></td>
                </tr>
                <tr>
                    <td>BT.2020</td>
                    <td>PQ</td>
                    <td>RGB</td>
                    <td>30</td>
                    <td>false</td>
                    <td><code>VK_COLOR_SPACE_HDR10_ST2084_EXT</code><br><code>VK_FORMAT_A2B10G10R10_UNORM_PACK32</code></td>
                </tr>
                <tr>
                    <td>BT.709</td>
                    <td>sRGB</td>
                    <td>RGB</td>
                    <td>30</td>
                    <td>false</td>
                    <td><code>VK_COLOR_SPACE_SRGB_NONLINEAR_KHR</code><br><code>VK_FORMAT_A2B10G10B10_UNORM_PACK32</code>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</figure>
<p>This representation is now used in the default render pipeline with the <code>output_system</code> in order to
make conversion easy. If you have a shader that wants to support this, you only have to use the
<code>linear_srgb_to_color_space(float3 color)</code> when you output to the color target.</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Pipeline for converting from HDR accumulation buffer to native HDR." src="../../images/hdr__pipeline.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Pipeline for converting from HDR accumulation buffer to native HDR.</h4>
    </figcaption>
  </figure>
<p>So this is the full pipeline for converting from our HDR accumulation buffer to a native HDR (in
this example HDR10) swap chain:</p>
<ol>
<li>Perform lighting in some linear color space.</li>
<li>Apply post-processing and color grading like normal.</li>
<li>Apply scene tone mapping.</li>
<li>Blend separately rendered UI using a composition step.</li>
<li>Convert from linear input space to CIE-XYZ.</li>
<li>Convert from CIE-XYZ to the desired output color primary.</li>
<li>Apply the desired transfer function.</li>
</ol>
<h2 id="so-thats-it-right-not-yet">So that’s it, right? Not yet.</h2>
<h3 id="text-blending">Text Blending</h3>
<p>There is a pretty annoying reason why we can’t actually use the automatic sRGB back buffer color
targets that APIs like Vulkan offer. This has to do with the way these formats are blended in the
frame buffer. Blending colors should be done in linear space, otherwise, the resulting color is not
physically correct. Let’s use an example of adding [0.25, 0.25, 0.25] and [0.75, 0.75, 0.75] with
and without a simple transfer function:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Blending colors in linear and non-linear space." src="../../images/hdr__math_blending.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4>Blending colors in linear and non-linear space.</h4>
    </figcaption>
  </figure>
<p>The nice thing about sRGB back buffer formats is that they will perform their blending in linear
space, so you don’t have to worry about this. However… most applications don’t actually do this
correctly. In the left image, we are using correct blending and in the right image, we are not. You
can see that the text in the right image is closer to the reference notepad text.</p>
<p>So if we would actually use the sRGB back buffer our text would look weird to most people even
though it would be physically correct. Now there are ways to go around this, but it’s easier to just
accept this flaw and move on.</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="When we blend text “correctly” it doesn’t match what the user expects from using system software such as Notepad." src="../../images/hdr__text_blending.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>When we blend text “correctly” it doesn’t match what the user expects from using system software such as Notepad.</h4>
    </figcaption>
  </figure>
<h3 id="precision-isnt-great">Precision isn’t great</h3>
<p>The viewers in The Machinery are rendered differently than in the final application. In the final
application, we can just write to the swap chain and be done with it, but the editor is a bit
trickier. We instead render the viewers (scene tab, preview tab, etc.) to an intermediate texture
and then use that as an input for our GUI shader. This way, the editor GUI doesn’t have to know
about the viewers and will just treat them as textures. The problem is that the GUI shader (for
reasons discussed earlier) expects its colors to be in sRGB format instead of linear BT.709. This
means that if we want to use the default <code>output_system</code> we have to first convert from sRGB to
linear BT.709 only to convert back to sRGB if we’re rendering to LDR.</p>
<p>And the issue with <em>that</em> is that the transfer functions aren’t perfect since we’re working with
limited precision floating-point numbers:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Limited precision causes issues when we apply the transfer function and its inverse." src="../../images/hdr__precision.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Limited precision causes issues when we apply the transfer function and its inverse.</h4>
    </figcaption>
  </figure>
<p>In this graph, you can see the error if we convert from sRGB to linear and then back to sRGB. The
green line shows the expected output (with the green dots representing individual floating point
values assuming 8-bits), and the dotted red line shows the actual output. The subrange [2, 9] out of
the full [0, 255] range has errors. This is barely noticeable to the naked eye, but one of our unit
tests thankfully caught it. To solve this I added one more function to the <code>output_system</code>:
<code>srgb_to_color_space(float3 color)</code> . This function assumes that the input is in non-linear space
instead of linear space, allowing me to skip the double transfer function.</p>
<h3 id="assumptions-galore">Assumptions galore</h3>
<p>There are two assumptions that I want to briefly talk about that are important to know when
implementing a system like this. The first one is simple, row-major vs column-major matrices.</p>
<p>We use 3x3 matrices to convert from one color primary into another, for example, to convert from
BT.709 to BT.2020 we would use the following conversion
(<a href="http://web.archive.org/web/20210804193248/http://www.brucelindbloom.com/index.html?Eqn_RGB_XYZ_Matrix.html">derivation</a>):</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="" src="../../images/hdr__math_conversion_matrix.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4></h4>
    </figcaption>
  </figure>
<p>We need to be careful not to blindly copy these matrices from an online source as most of them use
row-major ordering. The Machinery (like many other engines) uses column-major matrices, so we need
to transpose them before using them.</p>
<p>The second assumption lies in the ST2084 PQ transfer function. The function is defined as follows</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="" src="../../images/hdr__math_st2084pq.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4></h4>
    </figcaption>
  </figure>
<p>The two values we’re concerned about here are F_D (which is our linear BT.2020 input color) and the
10,000 scalar value. This 10,000 is the maximum luminance (in NITS) of the PQ transfer function. If
you would use this function directly and inspect the output you’d see that it’s mathematically
correct, but the colors on the screen will look very washed out. Why is this?</p>
<p>It is because most monitors can’t actually display 10000 NITS (which would be about the same as a
street light worth of brightness for every square meter of the monitor). My display can for instance
only display an average of 350 NITS (I checked this with <a href="http://web.archive.org/web/20210804193248/https://www.microsoft.com/en-us/p/displayhdr-test/9nn1gpn70nf3">DisplayHDR
test</a>). Therefore we need to scale
this function accordingly:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="" src="../../images/hdr__math_st2084pq_scale.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4></h4>
    </figcaption>
  </figure>
<h3 id="testing-and-calibration">Testing and calibration</h3>
<p>Checking by eyeballing it will only get you so far white unit tests can point out smaller
inaccuracies that could otherwise go unnoticed. We currently have several unit tests in place for
making sure these colors are correct. First, we make sure that the conversion matrices being
generated are the ones we expect. This is being checked with the BT.709 matrices. Secondly, we have
a GPU read back unit test that writes a constant value to various types of images, converts it, and
then reads back the result. This test checks sRGB to sRGB and has caught several issues already.</p>
<p>But, in order to really test whether these colors are correct, we should calibrate our monitors and
then measure the luminance produced by our application relative to the calibration software. Sadly,
I don’t have a hardware calibrator and they are rather expensive, so I have not done this step yet.</p>
<h2 id="wrap-up">Wrap up</h2>
<p>Currently, The Machinery fully supports outputting to sRGB and HDR10 capable displays, but adding
additional color spaces has been made easier by this system. Only the <code>output_sytem</code> has to know
about what the actual output space is which makes it really easy to support HDR.</p>
<p>Color is a fascinating and very broad topic which I would like to get more into in the future.
Possibly by adding additional tools for color grading and scene calibration using things like
Macbeth charts and a vectorscope.</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/authors/frank" class="text-decoration-none">Frank de Jong</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804193248/https://twitter.com/share?text=Supporting%20Native%20HDR%20Monitors - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fsupporting-native-hdr-monitors%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804193248/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fsupporting-native-hdr-monitors%2f&amp;description=Supporting%20Native%20HDR%20Monitors" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/a-debugging-story/" class="text-decoration-none"><img src="../../images/a-debugging-story.png" class="card-img-top" alt="A Debugging Story"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/a-debugging-story/">A Debugging Story</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2021-05-03T00:00:00Z">
                      3 May 2021
                    </time>
                  </h6>
                  <p class="card-text"><p>I&rsquo;ve been wanting for some time to write something about debugging. I think it&rsquo;s a really important
topic …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/a-debugging-story/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">1 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/beta-2021-4/" class="text-decoration-none"><img src="../../images/beta_21_4__triggers.png" class="card-img-top" alt="The Machinery Beta — April 2021 (version 2021.4)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta-2021-4/">The Machinery Beta — April 2021 (version 2021.4)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2021-04-29T00:00:00Z">
                      29 Apr 2021
                    </time>
                  </h6>
                  <p class="card-text">It’s that time again! A new month and a new The Machinery release. Hope you are enjoying the longer, sunnier days, as …</p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta-2021-4/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">7 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/gamepad-implementation-on-linux/" class="text-decoration-none"><img src="../../images/gamepad__gamepad.png" class="card-img-top" alt="Gamepad Implementation on Linux"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/gamepad-implementation-on-linux/">Gamepad Implementation on Linux</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2021-04-26T00:00:00Z">
                      26 Apr 2021
                    </time>
                  </h6>
                  <p class="card-text"><p>Hey everyone! If you remember my last
<a href=" ../../post/porting-the-machinery-to-linux/">post</a>, one of the missing features
was joystick support on Linux, which I’d say is …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/gamepad-implementation-on-linux/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">7 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/supporting-native-hdr-monitors/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20210804193248/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804193248/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/cdn-cgi/l/email-protection#394950575e79564c4b54585a5150575c4b40175a5654" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
        <p>&copy; Our Machinery 2021 <a style="text-decoration:none; margin-left:1em;" href="http://web.archive.org/web/20210804193248/https://ourmachinery.com/privacy.html">Privacy Policy</a></p>
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 19:32:48 Aug 04, 2021 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:51:47 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 1679.108
  exclusion.robots: 0.082
  exclusion.robots.policy: 0.075
  RedisCDXSource: 4.316
  esindex: 0.008
  LoadShardBlock: 1657.378 (3)
  PetaboxLoader3.resolve: 1602.637 (4)
  PetaboxLoader3.datanode: 65.928 (4)
  CDXLines.iter: 15.03 (3)
  load_resource: 43.907
-->